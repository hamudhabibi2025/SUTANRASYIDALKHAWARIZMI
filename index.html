<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSSI Mentawai - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Gaya Khusus */
        body { background-color: #f8f9fa; }
        #login-container { height: 100vh; display: flex; align-items: center; justify-content: center; }
        .dashboard-header { background-color: #4b0082; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-link.active { font-weight: bold; }
        .data-card { margin-top: 20px; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .table thead th { position: sticky; top: 0; background: #fff; z-index: 10; }
    </style>
</head>
<body>

    <script>
        // ==============================================================================
        // !!! WAJIB GANTI INI DENGAN URL WEB APP APPS SCRIPT ANDA (HARUS BERAKHIR /exec) !!!
        // ==============================================================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOkpgcTeEoV239l9dlehpiBqFXSJoNu4z2HjiAmyxjrbtFX7LicellXP-l4PCCDKw/exec"; 
        
        
        // --- UTILITY FUNCTIONS ---
        
        let $sessionData = { user: null, token: null };
        let currentPlayersA2 = []; // Cache data pemain A2

        function showNotification(message, type = 'info') {
            const alertPlaceholder = document.getElementById('alertPlaceholder');
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');
            alertPlaceholder.append(wrapper);
            setTimeout(() => wrapper.remove(), 5000);
        }

        async function postData(args) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // Mengirim JSON
                    },
                    body: JSON.stringify(args)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();

            } catch (error) {
                console.error("Fetch Error:", error);
                showNotification(`Koneksi gagal ke server Apps Script. Error: ${error.message}`, 'danger');
                return { success: false, message: "Koneksi gagal ke server Apps Script. Cek URL dan Deployment." };
            }
        }

        // --- MANAJEMEN SESI ---

        function saveSession(token) {
            localStorage.setItem('pssi_mentawai_token', token);
            $sessionData.token = token;
        }

        function clearSession() {
            localStorage.removeItem('pssi_mentawai_token');
            $sessionData = { user: null, token: null };
            renderPage();
        }

        async function checkSession() {
            const token = localStorage.getItem('pssi_mentawai_token');
            if (!token || token === "null") {
                renderPage();
                return;
            }

            const result = await postData({ action: 'getSessionData', token: token });

            if (result.success) {
                $sessionData.token = token;
                $sessionData.user = result.user;
                renderPage('dashboard');
            } else {
                clearSession();
            }
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const result = await postData({ 
                action: 'login', 
                username: username, 
                password: password 
            });

            if (result.success) {
                saveSession(result.token);
                showNotification(result.message, 'success');
                setTimeout(() => checkSession(), 500); 
            } else {
                showNotification(result.message, 'danger');
            }
        }
        
        async function handleLogout() {
            if ($sessionData.token) {
                await postData({ action: 'logout', token: $sessionData.token });
            }
            clearSession();
            showNotification("Anda telah logout.", 'info');
        }

        // --- RENDER HALAMAN ---

        function renderLoginPage() {
            document.getElementById('app').innerHTML = `
                <div id="login-container">
                    <div class="card shadow" style="max-width: 400px; width: 90%;">
                        <div class="card-header bg-primary text-white text-center">
                            <h4>PSSI Mentawai Admin</h4>
                            <small>Masuk ke Dashboard</small>
                        </div>
                        <div class="card-body">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Login</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function renderDashboardPage() {
            const user = $sessionData.user;
            document.getElementById('app').innerHTML = `
                <div class="dashboard-header d-flex justify-content-between align-items-center">
                    <h5>Dashboard PSSI Mentawai</h5>
                    <div>
                        <span class="me-3 badge bg-light text-dark">${user.userType}</span>
                        <span class="me-3">${user.fullName} (${user.username})</span>
                        <button onclick="handleLogout()" class="btn btn-sm btn-light"><i class="fas fa-sign-out-alt"></i> Logout</button>
                    </div>
                </div>
                <div class="container-fluid mt-4">
                    <ul class="nav nav-tabs" id="mainTab" role="tablist">
                        <li class="nav-item"><a class="nav-link active" id="a1-tab" data-bs-toggle="tab" data-bs-target="#a1" type="button">Data Klub (A1)</a></li>
                        <li class="nav-item"><a class="nav-link" id="a2-tab" data-bs-toggle="tab" data-bs-target="#a2" type="button" onclick="loadPlayersA2()">Pemain Kolektif (A2)</a></li>
                        <li class="nav-item"><a class="nav-link" id="a3-tab" data-bs-toggle="tab" data-bs-target="#a3" type="button">Pendaftaran Pertandingan (A3)</a></li>
                        <li class="nav-item"><a class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button">Berita</a></li>
                        <li class="nav-item"><a class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button">Chat Admin</a></li>
                    </ul>
                    <div class="tab-content" id="mainTabContent">
                        <div class="tab-pane fade show active" id="a1" role="tabpanel">
                            <div class="data-card card shadow-sm p-4">
                                <h3>Data Klub Anda (A1)</h3>
                                <div id="a1-content" class="mt-3">Loading data...</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="a2" role="tabpanel">
                            <div class="data-card card shadow-sm p-4">
                                <h3 class="d-flex justify-content-between align-items-center">
                                    Daftar Pemain Kolektif (A2)
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#playerModal" onclick="preparePlayerModal('add')"><i class="fas fa-plus"></i> Tambah Pemain</button>
                                </h3>
                                <div id="a2-content" class="mt-3">Loading data...</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="a3" role="tabpanel">... Konten A3 ...</div>
                        <div class="tab-pane fade" id="news" role="tabpanel">... Konten Berita ...</div>
                        <div class="tab-pane fade" id="chat" role="tabpanel">... Konten Chat ...</div>
                    </div>
                </div>
            `;
            // Panggil fungsi untuk memuat data A1 saat dashboard dimuat
            loadDataA1();
        }

        function renderPage(page) {
            document.getElementById('alertPlaceholder').innerHTML = '';
            if (page === 'dashboard' || ($sessionData.token && $sessionData.user)) {
                renderDashboardPage();
            } else {
                renderLoginPage();
            }
        }
        
        // --- LOGIKA A1 (Data Klub) ---
        
        async function loadDataA1() {
             const result = await postData({ 
                action: 'getDataA1', 
                token: $sessionData.token
            });
            const contentDiv = document.getElementById('a1-content');

            if (result.success && result.data.id_klub) {
                const data = result.data;
                contentDiv.innerHTML = `
                    <p><strong>ID Klub:</strong> ${data.id_klub}</p>
                    <p><strong>Nama Klub:</strong> ${data.nama_klub}</p>
                    <p><strong>Ketua Klub:</strong> ${data.ketua_klub || '-'}</p>
                    <p><strong>Alamat:</strong> ${data.alamat_klub || '-'}</p>
                    <p><strong>No. Telepon:</strong> ${data.no_telp || '-'}</p>
                    <p><strong>Email:</strong> ${data.email_klub || '-'}</p>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#a1Modal" 
                        onclick="prepareA1Modal('${data.ketua_klub}', '${data.alamat_klub}', '${data.no_telp}', '${data.email_klub}')">
                        <i class="fas fa-edit"></i> Edit Data Klub
                    </button>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-warning">Data klub (A1) belum terisi. Silakan lengkapi.</div>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#a1Modal" onclick="prepareA1Modal()">
                        <i class="fas fa-plus"></i> Isi Data Klub Sekarang
                    </button>
                `;
            }
        }

        function prepareA1Modal(ketua = '', alamat = '', telp = '', email = '') {
            document.getElementById('a1-klub-id').value = $sessionData.user.idKlub;
            document.getElementById('a1-klub-name').value = $sessionData.user.namaKlub;
            document.getElementById('a1-ketua').value = ketua;
            document.getElementById('a1-alamat').value = alamat;
            document.getElementById('a1-telp').value = telp;
            document.getElementById('a1-email').value = email;
        }

        async function submitA1Form(event) {
            event.preventDefault();
            const form = document.getElementById('a1Form');
            const data = {
                action: 'submitA1',
                token: $sessionData.token,
                idKlub: form.elements['a1-klub-id'].value,
                namaKlub: form.elements['a1-klub-name'].value,
                ketuaKlub: form.elements['a1-ketua'].value,
                alamatKlub: form.elements['a1-alamat'].value,
                noTelp: form.elements['a1-telp'].value,
                emailKlub: form.elements['a1-email'].value,
            };

            const result = await postData(data);
            showNotification(result.message, result.success ? 'success' : 'danger');
            if (result.success) {
                // Tutup modal dan muat ulang data
                const modal = bootstrap.Modal.getInstance(document.getElementById('a1Modal'));
                modal.hide();
                loadDataA1();
            }
        }
        
        // --- LOGIKA A2 (Pemain Kolektif) ---

        async function loadPlayersA2() {
            const result = await postData({ action: 'getPlayersA2', token: $sessionData.token });
            const contentDiv = document.getElementById('a2-content');
            
            if (result.success) {
                currentPlayersA2 = result.data; // Simpan ke cache
                renderPlayersTable(result.data);
            } else {
                contentDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            }
        }
        
        function renderPlayersTable(players) {
            const contentDiv = document.getElementById('a2-content');
            if (players.length === 0) {
                contentDiv.innerHTML = '<div class="alert alert-info">Belum ada pemain yang terdaftar.</div>';
                return;
            }

            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="bg-light">
                            <tr>
                                <th>#</th>
                                <th>ID Pemain</th>
                                <th>Nama Lengkap</th>
                                <th>NPG</th>
                                <th>Tanggal Lahir</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            players.forEach((p, index) => {
                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${p.id_pemain}</td>
                        <td>${p.nama_lengkap}</td>
                        <td>${p.npg}</td>
                        <td>${p.tanggal_lahir}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#playerModal" onclick="preparePlayerModal('edit', ${p.rowIndex})"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePlayerA2(${p.rowIndex})"><i class="fas fa-trash"></i> Hapus</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += '</tbody></table></div>';
            contentDiv.innerHTML = tableHtml;
        }

        function preparePlayerModal(mode, rowIndex = null) {
            const modalTitle = document.getElementById('playerModalLabel');
            const form = document.getElementById('playerForm');
            form.reset();
            form.elements['mode'].value = mode;
            form.elements['rowIndex'].value = rowIndex;
            form.elements['id_pemain'].readOnly = (mode === 'edit');
            
            if (mode === 'add') {
                modalTitle.textContent = "Tambah Pemain Baru";
            } else {
                modalTitle.textContent = "Edit Data Pemain";
                const player = currentPlayersA2.find(p => p.rowIndex == rowIndex);
                if (player) {
                    // Isi form dengan data pemain yang akan diedit
                    form.elements['id_pemain'].value = player.id_pemain;
                    form.elements['nama_lengkap'].value = player.nama_lengkap;
                    form.elements['nama_punggung'].value = player.nama_punggung;
                    form.elements['npg'].value = player.npg;
                    form.elements['tanggal_lahir'].value = player.tanggal_lahir;
                    form.elements['usia'].value = player.usia;
                    form.elements['keterangan'].value = player.keterangan;
                }
            }
        }

        async function submitPlayerForm(event) {
            event.preventDefault();
            const form = event.target;
            const mode = form.elements['mode'].value;

            const data = {
                action: 'savePlayerA2',
                token: $sessionData.token,
                mode: mode,
                rowIndex: form.elements['rowIndex'].value,
                idKlub: $sessionData.user.idKlub,
                namaKlub: $sessionData.user.namaKlub,
                id_pemain: form.elements['id_pemain'].value,
                nama_lengkap: form.elements['nama_lengkap'].value,
                nama_punggung: form.elements['nama_punggung'].value,
                npg: form.elements['npg'].value,
                tanggal_lahir: form.elements['tanggal_lahir'].value,
                usia: form.elements['usia'].value,
                keterangan: form.elements['keterangan'].value,
            };

            const result = await postData(data);
            showNotification(result.message, result.success ? 'success' : 'danger');
            
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('playerModal'));
                modal.hide();
                loadPlayersA2(); // Muat ulang tabel
            }
        }
        
        async function deletePlayerA2(rowIndex) {
             if (!confirm("Apakah Anda yakin ingin menghapus pemain ini?")) {
                return;
            }
            const result = await postData({ 
                action: 'deletePlayerA2', 
                token: $sessionData.token, 
                rowIndex: rowIndex
            });
            showNotification(result.message, result.success ? 'success' : 'danger');
            if (result.success) {
                loadPlayersA2();
            }
        }


        // --- INIT ---
        window.onload = checkSession;
    </script>

    <div id="alertPlaceholder" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

    <div id="app">
        </div>
    
    <div class="modal fade" id="a1Modal" tabindex="-1" aria-labelledby="a1ModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="a1Form" onsubmit="submitA1Form(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="a1ModalLabel">Form Data Klub (A1)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">ID Klub</label>
                            <input type="text" class="form-control" id="a1-klub-id" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Klub</label>
                            <input type="text" class="form-control" id="a1-klub-name" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="a1-ketua" class="form-label">Nama Ketua Klub</label>
                            <input type="text" class="form-control" id="a1-ketua" required>
                        </div>
                        <div class="mb-3">
                            <label for="a1-alamat" class="form-label">Alamat Klub</label>
                            <input type="text" class="form-control" id="a1-alamat" required>
                        </div>
                        <div class="mb-3">
                            <label for="a1-telp" class="form-label">No. Telepon</label>
                            <input type="tel" class="form-control" id="a1-telp" required>
                        </div>
                        <div class="mb-3">
                            <label for="a1-email" class="form-label">Email Klub</label>
                            <input type="email" class="form-control" id="a1-email" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="submit" class="btn btn-primary">Simpan Data Klub</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="playerForm" onsubmit="submitPlayerForm(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="playerModalLabel">Form Pemain Kolektif (A2)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="mode">
                        <input type="hidden" name="rowIndex">
                        <div class="mb-3">
                            <label for="id_pemain" class="form-label">ID Pemain (e.g. NIK)</label>
                            <input type="number" class="form-control" name="id_pemain" required>
                        </div>
                        <div class="mb-3">
                            <label for="nama_lengkap" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" name="nama_lengkap" required>
                        </div>
                         <div class="mb-3">
                            <label for="nama_punggung" class="form-label">Nama Punggung</label>
                            <input type="text" class="form-control" name="nama_punggung">
                        </div>
                         <div class="mb-3">
                            <label for="npg" class="form-label">No. Punggung (NPG)</label>
                            <input type="number" class="form-control" name="npg" required>
                        </div>
                        <div class="mb-3">
                            <label for="tanggal_lahir" class="form-label">Tanggal Lahir</label>
                            <input type="date" class="form-control" name="tanggal_lahir" required>
                        </div>
                        <div class="mb-3">
                            <label for="usia" class="form-label">Usia</label>
                            <input type="number" class="form-control" name="usia" required>
                        </div>
                        <div class="mb-3">
                            <label for="keterangan" class="form-label">Keterangan</label>
                            <textarea class="form-control" name="keterangan"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="submit" class="btn btn-primary">Simpan Pemain</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.getElementById('playerForm').addEventListener('submit', submitPlayerForm);
    </script>
</body>
</html>
