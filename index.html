<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSSI Mentawai - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* Gaya Khusus */
        body { background-color: #f8f9fa; }
        #login-container { height: 100vh; display: flex; align-items: center; justify-content: center; }
        .dashboard-header { background-color: #4b0082; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .data-card { margin-top: 20px; }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .table thead th { position: sticky; top: 0; background: #fff; z-index: 10; }
        #chat-history { height: 350px; overflow-y: scroll; padding: 10px; border: 1px solid #ccc; background-color: #f9f9f9; }
        .chat-message { margin-bottom: 8px; }
        .chat-message small { display: block; font-size: 0.75em; color: #888; }
        .chat-message strong { font-size: 0.9em; }
    </style>
</head>
<body>

    <script>
        // ==============================================================================
        // !!! WAJIB GANTI INI DENGAN URL WEB APP APPS SCRIPT ANDA (HARUS BERAKHIR /exec) !!!
        // ==============================================================================
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyOkpgcTeEoV239l9dlehpiBqFXSJoNu4z2HjiAmyxjrbtFX7LicellXP-l4PCCDKw/exec"; 
        
        // --- GLOBAL STATE ---
        let $sessionData = { user: null, token: null };
        let currentPlayersA2 = []; // Cache data pemain A2
        let currentFormsA3 = []; // Cache data form A3
        let currentNews = []; // Cache data berita

        // --- UTILITY FUNCTIONS ---
        function showNotification(message, type = 'info') {
            const alertPlaceholder = document.getElementById('alertPlaceholder');
            const wrapper = document.createElement('div');
            wrapper.innerHTML = [
                `<div class="alert alert-${type} alert-dismissible fade show" role="alert">`,
                `   <div>${message}</div>`,
                '   <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',
                '</div>'
            ].join('');
            alertPlaceholder.append(wrapper);
            setTimeout(() => wrapper.remove(), 5000);
        }

        async function postData(args) {
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(args)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();

            } catch (error) {
                console.error("Fetch Error:", error);
                showNotification(`Koneksi gagal ke server Apps Script. Cek URL dan Deployment. Error: ${error.message}`, 'danger');
                return { success: false, message: "Koneksi gagal ke server Apps Script. Cek URL dan Deployment." };
            }
        }

        // --- MANAJEMEN SESI & AUTH ---

        function saveSession(token) {
            localStorage.setItem('pssi_mentawai_token', token);
            $sessionData.token = token;
        }

        function clearSession() {
            localStorage.removeItem('pssi_mentawai_token');
            $sessionData = { user: null, token: null };
            renderPage();
        }

        async function checkSession() {
            const token = localStorage.getItem('pssi_mentawai_token');
            if (!token || token === "null") {
                renderPage();
                return;
            }

            const result = await postData({ action: 'getSessionData', token: token });

            if (result.success) {
                $sessionData.token = token;
                $sessionData.user = result.user;
                renderPage('dashboard');
            } else {
                clearSession();
            }
        }
        
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const result = await postData({ action: 'login', username: username, password: password });

            if (result.success) {
                saveSession(result.token);
                showNotification(result.message, 'success');
                setTimeout(() => checkSession(), 500); 
            } else {
                showNotification(result.message, 'danger');
            }
        }
        
        async function handleLogout() {
            if ($sessionData.token) {
                await postData({ action: 'logout', token: $sessionData.token });
            }
            clearSession();
            showNotification("Anda telah logout.", 'info');
        }
        
        // --- RENDER HALAMAN (Login & Dashboard) ---

        function renderLoginPage() {
            // ... (Kode Login Page - Sama seperti sebelumnya) ...
            document.getElementById('app').innerHTML = `
                <div id="login-container">
                    <div class="card shadow" style="max-width: 400px; width: 90%;">
                        <div class="card-header bg-primary text-white text-center">
                            <h4>PSSI Mentawai Admin</h4>
                            <small>Masuk ke Dashboard</small>
                        </div>
                        <div class="card-body">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" required>
                                </div>
                                <button type="submit" class="btn btn-primary w-100">Login</button>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        }

        function renderDashboardPage() {
            const user = $sessionData.user;
            const isAdminPusat = user.userType === 'ADMIN_PUSAT';
            document.getElementById('app').innerHTML = `
                <div class="dashboard-header d-flex justify-content-between align-items-center">
                    <h5>Dashboard PSSI Mentawai</h5>
                    <div>
                        <span class="me-3 badge bg-light text-dark">${user.userType}</span>
                        <span class="me-3">${user.fullName} (${user.username})</span>
                        <button onclick="handleLogout()" class="btn btn-sm btn-light"><i class="fas fa-sign-out-alt"></i> Logout</button>
                    </div>
                </div>
                <div class="container-fluid mt-4">
                    <ul class="nav nav-tabs" id="mainTab" role="tablist">
                        <li class="nav-item"><a class="nav-link active" id="a1-tab" data-bs-toggle="tab" data-bs-target="#a1" type="button">Data Klub (A1)</a></li>
                        <li class="nav-item"><a class="nav-link" id="a2-tab" data-bs-toggle="tab" data-bs-target="#a2" type="button" onclick="loadPlayersA2()">Pemain Kolektif (A2)</a></li>
                        <li class="nav-item"><a class="nav-link" id="a3-tab" data-bs-toggle="tab" data-bs-target="#a3" type="button" onclick="loadFormsA3()">Pendaftaran Pertandingan (A3)</a></li>
                        <li class="nav-item"><a class="nav-link" id="news-tab" data-bs-toggle="tab" data-bs-target="#news" type="button" onclick="loadNews()">Berita</a></li>
                        <li class="nav-item"><a class="nav-link" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat" type="button" onclick="loadChatHistory()">Chat Admin</a></li>
                    </ul>
                    <div class="tab-content" id="mainTabContent">
                        <div class="tab-pane fade show active" id="a1" role="tabpanel">
                            <div class="data-card card shadow-sm p-4">
                                <h3>Data Klub Anda (A1)</h3>
                                <div id="a1-content" class="mt-3">Loading data...</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="a2" role="tabpanel">
                            <div class="data-card card shadow-sm p-4">
                                <h3 class="d-flex justify-content-between align-items-center">Daftar Pemain Kolektif (A2)
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#playerModal" onclick="preparePlayerModal('add')"><i class="fas fa-plus"></i> Tambah Pemain</button>
                                </h3>
                                <div id="a2-content" class="mt-3">Loading data...</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="a3" role="tabpanel">
                            <div class="data-card card shadow-sm p-4">
                                <h3 class="d-flex justify-content-between align-items-center">Daftar Pendaftaran Pertandingan (A3)
                                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#a3Modal" onclick="prepareA3Modal('add')"><i class="fas fa-plus"></i> Daftar Pertandingan</button>
                                </h3>
                                <div id="a3-content" class="mt-3">Loading data...</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="news" role="tabpanel">
                            <div class="data-card card shadow-sm p-4">
                                <h3 class="d-flex justify-content-between align-items-center">Berita dan Pengumuman
                                    ${isAdminPusat ? '<button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newsModal" onclick="prepareNewsModal(\'add\')"><i class="fas fa-plus"></i> Publikasikan</button>' : ''}
                                </h3>
                                <div id="news-content" class="mt-3">Loading data...</div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="chat" role="tabpanel">
                            <div class="data-card card shadow-sm p-4">
                                <h3>Chat Antar Admin</h3>
                                <div id="chat-history"></div>
                                <form id="chatForm" class="mt-3 d-flex" onsubmit="sendChatMessage(event)">
                                    <input type="text" id="chat-input" class="form-control me-2" placeholder="Ketik pesan..." required>
                                    <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Kirim</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadDataA1();
        }

        function renderPage(page) {
            document.getElementById('alertPlaceholder').innerHTML = '';
            if (page === 'dashboard' || ($sessionData.token && $sessionData.user)) {
                renderDashboardPage();
            } else {
                renderLoginPage();
            }
        }
        
        // --- LOGIKA A1 (Data Klub) --- (Sama seperti sebelumnya)

        async function loadDataA1() {
             const result = await postData({ action: 'getDataA1', token: $sessionData.token });
             const contentDiv = document.getElementById('a1-content');
            // ... (lanjutkan logika rendering A1 dan fungsi prepareA1Modal/submitA1Form) ...
             if (result.success && result.data.id_klub) {
                const data = result.data;
                contentDiv.innerHTML = `
                    <p><strong>ID Klub:</strong> ${data.id_klub}</p>
                    <p><strong>Nama Klub:</strong> ${data.nama_klub}</p>
                    <p><strong>Ketua Klub:</strong> ${data.ketua_klub || '-'}</p>
                    <p><strong>Alamat:</strong> ${data.alamat_klub || '-'}</p>
                    <p><strong>No. Telepon:</strong> ${data.no_telp || '-'}</p>
                    <p><strong>Email:</strong> ${data.email_klub || '-'}</p>
                    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#a1Modal" 
                        onclick="prepareA1Modal('${data.ketua_klub}', '${data.alamat_klub}', '${data.no_telp}', '${data.email_klub}')">
                        <i class="fas fa-edit"></i> Edit Data Klub
                    </button>
                `;
            } else {
                contentDiv.innerHTML = `
                    <div class="alert alert-warning">Data klub (A1) belum terisi. Silakan lengkapi.</div>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#a1Modal" onclick="prepareA1Modal()">
                        <i class="fas fa-plus"></i> Isi Data Klub Sekarang
                    </button>
                `;
            }
        }

        function prepareA1Modal(ketua = '', alamat = '', telp = '', email = '') {
            document.getElementById('a1-klub-id').value = $sessionData.user.idKlub;
            document.getElementById('a1-klub-name').value = $sessionData.user.namaKlub;
            document.getElementById('a1-ketua').value = ketua;
            document.getElementById('a1-alamat').value = alamat;
            document.getElementById('a1-telp').value = telp;
            document.getElementById('a1-email').value = email;
        }

        async function submitA1Form(event) {
            event.preventDefault();
            const form = document.getElementById('a1Form');
            const data = {
                action: 'submitA1',
                token: $sessionData.token,
                idKlub: form.elements['a1-klub-id'].value,
                namaKlub: form.elements['a1-klub-name'].value,
                ketuaKlub: form.elements['a1-ketua'].value,
                alamatKlub: form.elements['a1-alamat'].value,
                noTelp: form.elements['a1-telp'].value,
                emailKlub: form.elements['a1-email'].value,
            };

            const result = await postData(data);
            showNotification(result.message, result.success ? 'success' : 'danger');
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('a1Modal'));
                modal.hide();
                loadDataA1();
            }
        }

        // --- LOGIKA A2 (Pemain Kolektif) --- (Sama seperti sebelumnya)
        async function loadPlayersA2() {
            const result = await postData({ action: 'getPlayersA2', token: $sessionData.token });
            const contentDiv = document.getElementById('a2-content');
            if (result.success) {
                currentPlayersA2 = result.data; 
                renderPlayersTable(result.data);
            } else {
                contentDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            }
        }
        
        function renderPlayersTable(players) {
            const contentDiv = document.getElementById('a2-content');
            if (players.length === 0) {
                contentDiv.innerHTML = '<div class="alert alert-info">Belum ada pemain yang terdaftar.</div>';
                return;
            }

            let tableHtml = `...`; // (Html table rendering)
            // ... (gunakan kode renderPlayersTable dari jawaban sebelumnya) ...
             let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="bg-light">
                            <tr>
                                <th>#</th>
                                <th>ID Pemain</th>
                                <th>Nama Lengkap</th>
                                <th>NPG</th>
                                <th>TTL</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            players.forEach((p, index) => {
                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${p.id_pemain}</td>
                        <td>${p.nama_lengkap}</td>
                        <td>${p.npg}</td>
                        <td>${p.tanggal_lahir}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#playerModal" onclick="preparePlayerModal('edit', ${p.rowindex})"><i class="fas fa-edit"></i> Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePlayerA2(${p.rowindex})"><i class="fas fa-trash"></i> Hapus</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += '</tbody></table></div>';
            contentDiv.innerHTML = tableHtml;
        }

        function preparePlayerModal(mode, rowIndex = null) {
            const modalTitle = document.getElementById('playerModalLabel');
            const form = document.getElementById('playerForm');
            form.reset();
            form.elements['mode'].value = mode;
            form.elements['rowIndex'].value = rowIndex;
            form.elements['id_pemain'].readOnly = (mode === 'edit');
            
            if (mode === 'add') {
                modalTitle.textContent = "Tambah Pemain Baru";
            } else {
                modalTitle.textContent = "Edit Data Pemain";
                const player = currentPlayersA2.find(p => p.rowindex == rowIndex);
                if (player) {
                    form.elements['id_pemain'].value = player.id_pemain;
                    form.elements['nama_lengkap'].value = player.nama_lengkap;
                    form.elements['nama_punggung'].value = player.nama_punggung;
                    form.elements['npg'].value = player.npg;
                    form.elements['tanggal_lahir'].value = player.tanggal_lahir;
                    form.elements['usia'].value = player.usia;
                    form.elements['keterangan'].value = player.keterangan;
                }
            }
        }

        async function submitPlayerForm(event) {
            event.preventDefault();
            const form = event.target;
            const data = {
                action: 'savePlayerA2',
                token: $sessionData.token,
                mode: form.elements['mode'].value,
                rowIndex: form.elements['rowIndex'].value,
                idKlub: $sessionData.user.idKlub,
                namaKlub: $sessionData.user.namaKlub,
                id_pemain: form.elements['id_pemain'].value,
                nama_lengkap: form.elements['nama_lengkap'].value,
                nama_punggung: form.elements['nama_punggung'].value,
                npg: form.elements['npg'].value,
                tanggal_lahir: form.elements['tanggal_lahir'].value,
                usia: form.elements['usia'].value,
                keterangan: form.elements['keterangan'].value,
            };

            const result = await postData(data);
            showNotification(result.message, result.success ? 'success' : 'danger');
            
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('playerModal'));
                modal.hide();
                loadPlayersA2();
            }
        }
        
        async function deletePlayerA2(rowIndex) {
             if (!confirm("Apakah Anda yakin ingin menghapus pemain ini?")) {
                return;
            }
            const result = await postData({ action: 'deletePlayerA2', token: $sessionData.token, rowIndex: rowIndex });
            showNotification(result.message, result.success ? 'success' : 'danger');
            if (result.success) {
                loadPlayersA2();
            }
        }
        
        // --- LOGIKA A3 (Pendaftaran Pertandingan) ---
        
        async function loadFormsA3() {
            const result = await postData({ action: 'getFormA3', token: $sessionData.token });
            const contentDiv = document.getElementById('a3-content');
            if (result.success) {
                currentFormsA3 = result.data;
                renderFormsA3Table(result.data);
            } else {
                 contentDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            }
        }
        
        function renderFormsA3Table(forms) {
            const contentDiv = document.getElementById('a3-content');
             if (forms.length === 0) {
                contentDiv.innerHTML = '<div class="alert alert-info">Belum ada pendaftaran pertandingan.</div>';
                return;
            }
            // ... (lanjutkan logika rendering tabel A3) ...
             let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="bg-light">
                            <tr>
                                <th>#</th>
                                <th>Tanggal Daftar</th>
                                <th>Tgl. Pertandingan</th>
                                <th>Lawan</th>
                                <th>Lokasi</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            forms.forEach((f, index) => {
                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${new Date(f.tanggal_pendaftaran).toLocaleDateString()}</td>
                        <td>${f.tgl_pertandingan}</td>
                        <td>${f.lawan}</td>
                        <td>${f.lokasi}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-2" data-bs-toggle="modal" data-bs-target="#a3Modal" onclick="prepareA3Modal('edit', ${f.rowindex})"><i class="fas fa-edit"></i> Edit</button>
                            </td>
                    </tr>
                `;
            });
            tableHtml += '</tbody></table></div>';
            contentDiv.innerHTML = tableHtml;
        }

        function prepareA3Modal(mode, rowIndex = null) {
            const modalTitle = document.getElementById('a3ModalLabel');
            const form = document.getElementById('a3Form');
            form.reset();
            form.elements['mode'].value = mode;
            form.elements['rowIndex'].value = rowIndex;
            
            if (mode === 'add') {
                modalTitle.textContent = "Daftar Pertandingan Baru";
            } else {
                modalTitle.textContent = "Edit Pendaftaran Pertandingan";
                const formA3 = currentFormsA3.find(f => f.rowindex == rowIndex);
                if (formA3) {
                    form.elements['tgl_pertandingan'].value = formA3.tgl_pertandingan;
                    form.elements['lawan'].value = formA3.lawan;
                    form.elements['lokasi'].value = formA3.lokasi;
                    form.elements['catatan'].value = formA3.catatan;
                }
            }
        }

        async function submitA3Form(event) {
            event.preventDefault();
            const form = event.target;
            const data = {
                action: 'submitA3',
                token: $sessionData.token,
                mode: form.elements['mode'].value,
                rowIndex: form.elements['rowIndex'].value,
                idKlub: $sessionData.user.idKlub,
                namaKlub: $sessionData.user.namaKlub,
                tgl_pertandingan: form.elements['tgl_pertandingan'].value,
                lawan: form.elements['lawan'].value,
                lokasi: form.elements['lokasi'].value,
                catatan: form.elements['catatan'].value,
            };

            const result = await postData(data);
            showNotification(result.message, result.success ? 'success' : 'danger');
            
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('a3Modal'));
                modal.hide();
                loadFormsA3();
            }
        }
        
        // --- LOGIKA NEWS ---
        
        async function loadNews() {
            const result = await postData({ action: 'getNews', token: $sessionData.token }); // Token tetap dikirim untuk auth header (jika diperlukan)
            const contentDiv = document.getElementById('news-content');
            
            if (result.success) {
                currentNews = result.data;
                renderNewsList(result.data);
            } else {
                contentDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            }
        }

        function renderNewsList(newsList) {
            const contentDiv = document.getElementById('news-content');
            if (newsList.length === 0) {
                contentDiv.innerHTML = '<div class="alert alert-info">Belum ada berita atau pengumuman.</div>';
                return;
            }

            let html = '<div class="list-group">';
            newsList.forEach(n => {
                html += `
                    <div class="list-group-item list-group-item-action flex-column align-items-start">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${n.judul}</h5>
                            <small>${new Date(n.timestamp).toLocaleDateString()}</small>
                        </div>
                        <p class="mb-1">${n.konten}</p>
                        <small>Dipublikasikan oleh: ${n.admin_publikasi}</small>
                        ${$sessionData.user.userType === 'ADMIN_PUSAT' ? `<button class="btn btn-sm btn-outline-warning ms-2" data-bs-toggle="modal" data-bs-target="#newsModal" onclick="prepareNewsModal('edit', ${n.rowindex})"><i class="fas fa-edit"></i></button>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            contentDiv.innerHTML = html;
        }
        
        function prepareNewsModal(mode, rowIndex = null) {
            const modalTitle = document.getElementById('newsModalLabel');
            const form = document.getElementById('newsForm');
            form.reset();
            form.elements['mode'].value = mode;
            form.elements['rowIndex'].value = rowIndex;

            if (mode === 'add') {
                modalTitle.textContent = "Publikasikan Berita Baru";
            } else {
                modalTitle.textContent = "Edit Berita";
                const news = currentNews.find(n => n.rowindex == rowIndex);
                if (news) {
                    form.elements['judul'].value = news.judul;
                    form.elements['konten'].value = news.konten;
                }
            }
        }

        async function submitNewsForm(event) {
            event.preventDefault();
            const form = event.target;
            const data = {
                action: 'publishNews',
                token: $sessionData.token,
                mode: form.elements['mode'].value,
                rowIndex: form.elements['rowIndex'].value,
                judul: form.elements['judul'].value,
                konten: form.elements['konten'].value,
            };

            const result = await postData(data);
            showNotification(result.message, result.success ? 'success' : 'danger');
            
            if (result.success) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('newsModal'));
                modal.hide();
                loadNews();
            }
        }

        // --- LOGIKA CHAT ---
        
        async function loadChatHistory() {
            const result = await postData({ action: 'getChatHistory', token: $sessionData.token });
            const chatDiv = document.getElementById('chat-history');
            
            if (result.success) {
                renderChatHistory(result.data);
            } else {
                chatDiv.innerHTML = `<div class="alert alert-danger">${result.message}</div>`;
            }
        }
        
        function renderChatHistory(history) {
            const chatDiv = document.getElementById('chat-history');
            chatDiv.innerHTML = '';
            
            history.forEach(c => {
                const isMine = c.username === $sessionData.user.username;
                const alignment = isMine ? 'text-end' : 'text-start';
                const color = isMine ? 'alert-info' : 'alert-light';
                
                chatDiv.innerHTML += `
                    <div class="chat-message ${alignment}">
                        <div class="alert ${color} p-2 d-inline-block" style="max-width: 75%;">
                            <strong class="${isMine ? 'text-primary' : 'text-success'}">${c.full_name}</strong>
                            <div>${c.message}</div>
                            <small>${new Date(c.timestamp).toLocaleTimeString()}</small>
                        </div>
                    </div>
                `;
            });
            // Scroll ke pesan terbaru
            chatDiv.scrollTop = chatDiv.scrollHeight;
            // Set timeout untuk auto-refresh (misalnya setiap 10 detik)
            setTimeout(loadChatHistory, 10000); 
        }

        async function sendChatMessage(event) {
            event.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value;
            
            const result = await postData({ 
                action: 'sendChat', 
                token: $sessionData.token, 
                message: message 
            });
            
            if (result.success) {
                input.value = ''; // Kosongkan input
                loadChatHistory();
            } else {
                showNotification("Gagal mengirim pesan chat.", 'danger');
            }
        }

        // --- INIT ---
        window.onload = checkSession;
    </script>

    <div id="alertPlaceholder" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

    <div id="app">
        </div>
    
    <div class="modal fade" id="a1Modal" tabindex="-1" aria-labelledby="a1ModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="a1Form" onsubmit="submitA1Form(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="a1ModalLabel">Form Data Klub (A1)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">ID Klub</label>
                            <input type="text" class="form-control" id="a1-klub-id" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nama Klub</label>
                            <input type="text" class="form-control" id="a1-klub-name" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="a1-ketua" class="form-label">Nama Ketua Klub</label>
                            <input type="text" class="form-control" id="a1-ketua" required>
                        </div>
                        <div class="mb-3">
                            <label for="a1-alamat" class="form-label">Alamat Klub</label>
                            <input type="text" class="form-control" id="a1-alamat" required>
                        </div>
                        <div class="mb-3">
                            <label for="a1-telp" class="form-label">No. Telepon</label>
                            <input type="tel" class="form-control" id="a1-telp" required>
                        </div>
                        <div class="mb-3">
                            <label for="a1-email" class="form-label">Email Klub</label>
                            <input type="email" class="form-control" id="a1-email" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="submit" class="btn btn-primary">Simpan Data Klub</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="playerModal" tabindex="-1" aria-labelledby="playerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="playerForm" onsubmit="submitPlayerForm(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="playerModalLabel">Form Pemain Kolektif (A2)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="mode">
                        <input type="hidden" name="rowIndex">
                        <div class="mb-3">
                            <label for="id_pemain" class="form-label">ID Pemain (e.g. NIK)</label>
                            <input type="number" class="form-control" name="id_pemain" required>
                        </div>
                        <div class="mb-3">
                            <label for="nama_lengkap" class="form-label">Nama Lengkap</label>
                            <input type="text" class="form-control" name="nama_lengkap" required>
                        </div>
                         <div class="mb-3">
                            <label for="nama_punggung" class="form-label">Nama Punggung</label>
                            <input type="text" class="form-control" name="nama_punggung">
                        </div>
                         <div class="mb-3">
                            <label for="npg" class="form-label">No. Punggung (NPG)</label>
                            <input type="number" class="form-control" name="npg" required>
                        </div>
                        <div class="mb-3">
                            <label for="tanggal_lahir" class="form-label">Tanggal Lahir</label>
                            <input type="date" class="form-control" name="tanggal_lahir" required>
                        </div>
                        <div class="mb-3">
                            <label for="usia" class="form-label">Usia</label>
                            <input type="number" class="form-control" name="usia" required>
                        </div>
                        <div class="mb-3">
                            <label for="keterangan" class="form-label">Keterangan</label>
                            <textarea class="form-control" name="keterangan"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="submit" class="btn btn-primary">Simpan Pemain</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="a3Modal" tabindex="-1" aria-labelledby="a3ModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="a3Form" onsubmit="submitA3Form(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="a3ModalLabel">Form Pendaftaran Pertandingan (A3)</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="mode">
                        <input type="hidden" name="rowIndex">
                        <div class="mb-3">
                            <label for="tgl_pertandingan" class="form-label">Tanggal Pertandingan</label>
                            <input type="date" class="form-control" name="tgl_pertandingan" required>
                        </div>
                        <div class="mb-3">
                            <label for="lawan" class="form-label">Lawan</label>
                            <input type="text" class="form-control" name="lawan" required>
                        </div>
                        <div class="mb-3">
                            <label for="lokasi" class="form-label">Lokasi</label>
                            <input type="text" class="form-control" name="lokasi" required>
                        </div>
                        <div class="mb-3">
                            <label for="catatan" class="form-label">Catatan Tambahan</label>
                            <textarea class="form-control" name="catatan"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="submit" class="btn btn-primary">Simpan Pendaftaran</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="newsModal" tabindex="-1" aria-labelledby="newsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="newsForm" onsubmit="submitNewsForm(event)">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newsModalLabel">Publikasikan Berita</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="mode">
                        <input type="hidden" name="rowIndex">
                        <div class="mb-3">
                            <label for="judul" class="form-label">Judul Berita</label>
                            <input type="text" class="form-control" name="judul" required>
                        </div>
                        <div class="mb-3">
                            <label for="konten" class="form-label">Konten Berita</label>
                            <textarea class="form-control" name="konten" rows="5" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                        <button type="submit" class="btn btn-primary">Publikasikan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
